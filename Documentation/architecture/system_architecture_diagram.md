# UVSD Enrichment System Architecture Diagram

## Complete System Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         EXTERNAL DATA SOURCES                               │
├─────────────────────────────────────────────────────────────────────────────┤
│  • Satellite Imagery Providers                                              │
│  • Aerial Photography Services                                              │
│  • Urban Planning Databases                                                 │
│  • Traffic Monitoring Systems                                               │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          DATA INGESTION PIPELINE                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐               │
│  │   DATA      │      │   IMAGE     │      │  ANNOTATION  │               │
│  │  SOURCES    │─────▶│   TILING    │─────▶│  CONVERSION  │               │
│  │             │      │   SERVICE   │      │   SERVICE    │               │
│  └─────────────┘      └─────────────┘      └─────────────┘               │
│         │                     │                     │                     │
│         │                     ▼                     ▼                     │
│         │              ┌─────────────┐      ┌─────────────┐               │
│         └─────────────▶│   QUALITY   │      │   FORMAT    │               │
│                        │   CONTROL   │      │  VALIDATION │               │
│                        └─────────────┘      └─────────────┘               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         PROCESSED DATA STORE                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      UVSD_Tiled_640/                               │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                │   │
│  │  │   IMAGES/   │  │   LABELS/    │  │  DATASET    │                │   │
│  │  │   train/    │  │   train/     │  │   CONFIG    │                │   │
│  │  │   val/      │  │   val/       │  │  (YAML)     │                │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                   COCO ANNOTATION FILES                            │   │
│  │  • instances_train.json                                            │   │
│  │  • instances_val.json                                             │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         VALIDATION & QUALITY ASSURANCE                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                 check_instances_vs_images.py                       │   │
│  │  • Cross-references images and annotations                         │   │
│  │  • Validates bounding box coordinates                              │   │
│  │  • Checks segmentation polygon integrity                           │   │
│  │  • Generates validation reports                                    │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      bbox_checks/                                   │   │
│  │  • Visual verification images                                       │   │
│  │  • Sample bounding box overlays                                     │   │
│  │  • Quality assessment metrics                                       │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         MODEL INFERENCE PIPELINE                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐               │
│  │   DATA      │      │   INTERNVL  │      │   ATTRIBUTE │               │
│  │   LOADER    │─────▶│     MODEL   │─────▶│  EXTRACTION │               │
│  │             │      │  (26B params)│      │   ENGINE    │               │
│  └─────────────┘      └─────────────┘      └─────────────┘               │
│         │                     │                     │                     │
│         │                     ▼                     ▼                     │
│         │              ┌─────────────┐      ┌─────────────┐               │
│         └─────────────▶│   GPU       │      │   RESULTS   │               │
│                        │   OPTIMIZER │      │   FORMATTER │               │
│                        └─────────────┘      └─────────────┘               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         RESULTS PROCESSING                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                    vehicle_instance_analysis_val.csv                │   │
│  │  • Annotation ID                                                    │   │
│  │  • Image ID                                                         │   │
│  │  • File Name                                                        │   │
│  │  • Bounding Box                                                     │   │
│  │  • Area                                                             │   │
│  │  • Model Output (JSON):                                             │   │
│  │      - color                                                        │   │
│  │      - angle                                                        │   │
│  │      - description                                                  │   │
│  │      - time_of_day                                                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         results/                                    │   │
│  │  • Analysis reports                                                 │   │
│  │  • Statistical summaries                                            │   │
│  │  • Visualization outputs                                            │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         INFRASTRUCTURE LAYER                                │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐               │
│  │   KAMIAK    │      │    SLURM    │      │     GPU     │               │
│  │   HPC       │─────▶│   SCHEDULER │─────▶│   CLUSTER   │               │
│  │   CLUSTER   │      │             │      │             │               │
│  └─────────────┘      └─────────────┘      └─────────────┘               │
│         │                     │                     │                     │
│         │                     ▼                     ▼                     │
│         │              ┌─────────────┐      ┌─────────────┐               │
│         └─────────────▶│   STORAGE   │      │   NETWORK   │               │
│                        │   SYSTEM    │      │   FABRIC    │               │
│                        └─────────────┘      └─────────────┘               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         MONITORING & LOGGING                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐               │
│  │   SYSTEM    │      │   MODEL     │      │   DATA      │               │
│  │   METRICS   │─────▶│   METRICS   │─────▶│   QUALITY   │               │
│  │             │      │             │      │   METRICS    │               │
│  └─────────────┘      └─────────────┘      └─────────────┘               │
│         │                     │                     │                     │
│         │                     ▼                     ▼                     │
│         │              ┌─────────────┐      ┌─────────────┐               │
│         └─────────────▶│   ALERTING  │      │   REPORTING  │               │
│                        │   SYSTEM     │      │   DASHBOARD │               │
│                        └─────────────┘      └─────────────┘               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         DOWNSTREAM APPLICATIONS                              │
├─────────────────────────────────────────────────────────────────────────────┤
│  • Urban Planning Analytics                                                 │
│  • Traffic Flow Optimization                                               │
│  • Autonomous Vehicle Training                                              │
│  • Geographic Information Systems                                           │
│  • Smart City Infrastructure                                               │
│  • Environmental Impact Assessment                                         │
│  • Emergency Response Planning                                              │
└─────────────────────────────────────────────────────────────────────────────┘

## Component Interaction Diagram

```
                            ┌─────────────────┐
                            │   USER/CLIENT   │
                            └─────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         API GATEWAY / INTERFACE                             │
├─────────────────────────────────────────────────────────────────────────────┤
│  • REST API Endpoints                                                       │
│  • Authentication & Authorization                                           │
│  • Rate Limiting                                                            │
│  • Request Validation                                                       │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                        ┌───────────┴───────────┐
                        ▼                       ▼
            ┌─────────────────────┐   ┌─────────────────────┐
            │    BATCH PROCESSING  │   │   REAL-TIME QUERY   │
            │       SERVICE       │   │      SERVICE       │
            └─────────────────────┘   └─────────────────────┘
                        │                       │
                        ▼                       ▼
            ┌─────────────────────┐   ┌─────────────────────┐
            │   DATA PROCESSING   │   │    QUERY ENGINE     │
            │      PIPELINE       │   │                     │
            └─────────────────────┘   └─────────────────────┘
                        │                       │
                        ▼                       ▼
            ┌─────────────────────────────────────────────────┐
            │              DATA STORAGE LAYER                  │
            ├─────────────────────────────────────────────────┤
            │  • File System (Images, Annotations)             │
            │  • Database (Metadata, Results)                 │
            │  • Cache (Frequently Accessed Data)             │
            └─────────────────────────────────────────────────┘
                                    │
                                    ▼
            ┌─────────────────────────────────────────────────┐
            │              MODEL SERVING LAYER                 │
            ├─────────────────────────────────────────────────┤
            │  • InternVL2 Model Inference                    │
            │  • GPU Acceleration                             │
            │  • Batch Processing Optimization                │
            └─────────────────────────────────────────────────┘
```

## Data Flow Sequence Diagram

```
User/Client          API Gateway          Batch Service         Model Service         Storage
    │                     │                     │                     │                 │
    │  Submit Job         │                     │                     │                 │
    │───────────────────▶│                     │                     │                 │
    │                     │                     │                     │                 │
    │                     │  Validate Request   │                     │                 │
    │                     │───────────────────▶│                     │                 │
    │                     │                     │                     │                 │
    │                     │                     │  Load Data          │                 │
    │                     │                     │─────────────────────┼────────────────▶│
    │                     │                     │                     │                 │
    │                     │                     │  Process Batch      │                 │
    │                     │                     │────────────────────▶│                 │
    │                     │                     │                     │  Run Inference │
    │                     │                     │                     │────────────────▶│
    │                     │                     │                     │                 │
    │                     │                     │                     │  Store Results │
    │                     │                     │                     │─────────────────┼─────▶│
    │                     │                     │                     │                 │
    │                     │  Return Job ID      │                     │                 │
    │◀────────────────────│                     │                     │                 │
    │                     │                     │                     │                 │
    │  Poll Status        │                     │                     │                 │
    │───────────────────▶│                     │                     │                 │
    │                     │  Check Progress     │                     │                 │
    │                     │───────────────────▶│                     │                 │
    │                     │                     │  Return Status      │                 │
    │                     │◀────────────────────│                     │                 │
    │  Return Status      │                     │                     │                 │
    │◀────────────────────│                     │                     │                 │
    │                     │                     │                     │                 │
    │  Retrieve Results   │                     │                     │                 │
    │───────────────────▶│                     │                     │                 │
    │                     │  Fetch Results      │                     │                 │
    │                     │─────────────────────┼─────────────────────┼────────────────▶│
    │                     │                     │                     │                 │
    │                     │  Return Results      │                     │                 │
    │◀────────────────────│                     │                     │                 │
    │                     │                     │                     │                 │
```

## Deployment Architecture

### On-Premises HPC Deployment (Current)
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          KAMIAK HPC CLUSTER                                 │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐               │
│  │   LOGIN    │      │   COMPUTE   │      │   STORAGE   │               │
│  │   NODE     │─────▶│   NODES     │─────▶│   NODES     │               │
│  │            │      │  (GPU)      │      │             │               │
│  └─────────────┘      └─────────────┘      └─────────────┘               │
│         │                     │                     │                     │
│         │                     ▼                     ▼                     │
│         │              ┌─────────────┐      ┌─────────────┐               │
│         └─────────────▶│   SLURM     │      │   PARALLEL  │               │
│                        │   SCHEDULER │      │   FILESYSTEM│               │
│                        └─────────────┘      └─────────────┘               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                          ┌─────────────────┐
                          │   USER ACCESS   │
                          │   (SSH/SFTP)    │
                          └─────────────────┘
```

### Cloud Deployment (Future)
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                          CLOUD INFRASTRUCTURE                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐               │
│  │   LOAD      │      │   CONTAINER │      │   OBJECT    │               │
│  │   BALANCER  │─────▶│   ORCHEST.  │─────▶│   STORAGE   │               │
│  │             │      │  (K8s/EKS)  │      │   (S3)      │               │
│  └─────────────┘      └─────────────┘      └─────────────┘               │
│         │                     │                     │                     │
│         │                     ▼                     ▼                     │
│         │              ┌─────────────┐      ┌─────────────┐               │
│         └─────────────▶│   GPU       │      │   DATABASE  │               │
│                        │   INSTANCES │      │   (RDS)     │               │
│                        └─────────────┘      └─────────────┘               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
                          ┌─────────────────┐
                          │   API GATEWAY   │
                          │   (API Gateway)  │
                          └─────────────────┘
                                    │
                                    ▼
                          ┌─────────────────┐
                          │   CLIENTS       │
                          │   (Web/Mobile)  │
                          └─────────────────┘
```

## Security Architecture

### Authentication & Authorization
```
┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
│     USER        │─────▶│   API GATEWAY   │─────▶│   AUTH SERVICE │
│  (Credentials)  │      │  (JWT Validation)│      │  (LDAP/OAuth)  │
└─────────────────┘      └─────────────────┘      └─────────────────┘
                                    │
                                    ▼
                          ┌─────────────────┐
                          │   RBAC POLICY   │
                          │   ENFORCEMENT   │
                          └─────────────────┘
                                    │
                                    ▼
                          ┌─────────────────┐
                          │   SERVICES      │
                          │   (Authorized)  │
                          └─────────────────┘
```

### Data Protection
```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              DATA PROTECTION                               │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐      ┌─────────────┐      ┌─────────────┐               │
│  │   DATA AT   │      │   DATA IN   │      │   DATA IN  │               │
│  │    REST     │─────▶│   TRANSIT   │─────▶│    USE     │               │
│  │  (Encrypted)│      │  (TLS/SSL)  │      │ (Memory)   │               │
│  └─────────────┘      └─────────────┘      └─────────────┘               │
│                                                                             │
│  • AES-256 Encryption                     • Secure Key Management          │
│  • Volume Encryption                       • Memory Encryption            │
│  • Access Control Lists                    • Secure Erasure               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Monitoring & Observability

### Metrics Collection
```
┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│   SYSTEM    │─────▶│   METRICS   │─────▶│   STORAGE   │
│   COMPONENTS│      │   AGENT     │      │  (Prometheus)│
└─────────────┘      └─────────────┘      └─────────────┘
        │                     │                     │
        ▼                     ▼                     ▼
┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│   LOG       │─────▶│   LOG       │─────▶│   LOG       │
│   GENERATION│      │   AGGREGATOR│      │   STORAGE   │
│             │      │             │      │  (ELK Stack)│
└─────────────┘      └─────────────┘      └─────────────┘
        │                     │                     │
        ▼                     ▼                     ▼
┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│   TRACING   │─────▶│   TRACING   │─────▶│   TRACING   │
│   INSTRUMENT│      │   COLLECTOR │      │   BACKEND   │
│             │      │             │      │  (Jaeger)   │
└─────────────┘      └─────────────┘      └─────────────┘
```

### Key Performance Indicators
- **Throughput**: Images processed per hour
- **Latency**: End-to-end processing time
- **Accuracy**: Model prediction accuracy
- **Resource Utilization**: GPU/CPU/Memory usage
- **Error Rate**: Processing failure rate
- **Data Quality**: Validation success rate

## Scalability Patterns

### Horizontal Scaling
```
┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│   LOAD      │─────▶│   WORKER    │─────▶│   WORKER    │
│   BALANCER  │      │   POOL 1    │      │   POOL N    │
└─────────────┘      └─────────────┘      └─────────────┘
        │                     │                     │
        ▼                     ▼                     ▼
┌─────────────┐      ┌─────────────┐      ┌─────────────┐
│   SHARED    │◀─────│   SHARED    │◀─────│   SHARED    │
│   STORAGE   │      │   STATE     │      │   STATE     │
└─────────────┘      └─────────────┘      └─────────────┘
```

### Vertical Scaling
- **GPU Memory**: Increase from 16GB → 80GB (A100/H100)
- **CPU Cores**: Increase from 8 → 64 cores
- **Storage I/O**: NVMe SSD → Parallel filesystem
- **Network**: 10GbE → 100GbE InfiniBand

### Data Partitioning
- **By Date**: Process daily batches independently
- **By Geographic Region**: Partition by city/region
- **By Vehicle Type**: Separate processing pipelines
- **By Priority**: High/medium/low priority queues